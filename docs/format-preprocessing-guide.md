# --format 전처리 기능 가이드

> Gemini Deep Research 클립보드 출력물을 구조화된 마크다운으로 변환

## 개요

`--format` 옵션은 **단일 라인 또는 비구조화된 마크다운**을 정상적인 문서 구조로 복원하는 전처리 기능입니다.

### 언제 사용해야 하나요?

| 상황 | `--format` 필요 여부 |
|------|---------------------|
| Gemini Deep Research에서 복사/붙여넣기한 텍스트 | **필수** |
| AI 도구에서 클립보드로 복사한 긴 단일 라인 텍스트 | **필수** |
| 줄바꿈 없이 모든 내용이 한 줄에 있는 경우 | **필수** |
| 이미 `##`, `###` 등으로 구조화된 마크다운 | 불필요 |
| 직접 작성한 정상적인 마크다운 파일 | 불필요 |

### 빠른 확인 방법

```bash
# 포맷팅이 필요한지 확인
uv run md_formatter.py --check input.md

# 결과 예시:
# [NEEDS FORMATTING] input.md        ← --format 사용 권장
# [OK] input.md appears already formatted  ← 그냥 변환해도 됨
```

---

## 사용법

### 기본 사용

```bash
# 전처리 후 Word 변환 (가장 일반적인 사용법)
uv run md_to_word.py input.md --format

# 전처리만 수행 (Word 변환 없이)
uv run md_formatter.py input.md

# 출력 파일명 지정
uv run md_formatter.py input.md output_formatted.md
```

### 변환 파이프라인

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   input.md      │────▶│  _formatted.md  │────▶│  _Report.docx   │
│  (단일 라인)     │     │  (구조화됨)      │     │  (Word 문서)    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │                       │
   md_formatter.py         중간 파일              md_to_word.py
   (전처리)               (자동 생성)             (최종 변환)
```

`--format` 사용 시:
1. `input.md` → `input_formatted.md` 생성 (전처리)
2. `input_formatted.md` → `input_Report_Pro.docx` 생성 (Word 변환)

---

## 전처리가 수행하는 변환

### 1. LaTeX 수식 보호

수식이 문장 분리 과정에서 손상되지 않도록 보호합니다.

```
변환 전: 공식은 $E=mc^2$이다.다음 문장은...
변환 후: 공식은 $E=mc^2$이다.

다음 문장은...
```

블록 수식(`$$...$$`)도 별도 단락으로 분리:

```
변환 전: ...결과이다.$$\int_0^1 f(x)dx$$따라서...
변환 후: ...결과이다.

$$\int_0^1 f(x)dx$$

따라서...
```

### 2. 메타데이터 추출 → YAML Frontmatter

보고서 정보를 YAML 형식으로 추출하여 표지 생성에 활용합니다.

```
변환 전:
[보고서] 네패스 기업분석작성일: 2026년 2월 7일수신: 투자위원회주제: 심층 기업 분석...

변환 후:
---
title: "네패스 기업분석"
date: "2026년 2월 7일"
recipient: "투자위원회"
subtitle: "심층 기업 분석"
---

...
```

### 3. 제목 구조 복원

번호 매김 패턴을 인식하여 마크다운 헤딩으로 변환합니다.

| 입력 패턴 | 출력 형식 | 마크다운 레벨 |
|----------|----------|-------------|
| `1. 서론` | `## 1. 서론` | H2 |
| `2.1. 배경` | `### 2.1. 배경` | H3 |
| `3.1.1. 세부사항` | `#### 3.1.1. 세부사항` | H4 |

```
변환 전: ...분석합니다.1. 서론글로벌 반도체 산업은...2.1. 배경네패스는...

변환 후:
...분석합니다.

## 1. 서론

글로벌 반도체 산업은...

### 2.1. 배경

네패스는...
```

### 4. 한국어 문장 경계 인식

한국어 종결어미 패턴을 감지하여 문단을 분리합니다.

**감지되는 종결어미:**
- `~다.`, `~요.`, `~음.`, `~함.`, `~임.`, `~됨.`
- `~니다.`, `~입니다.`, `~습니다.`, `~됩니다.`, `~합니다.`

```
변환 전: 매출이 증가했다.영업이익도 개선되었습니다.

변환 후:
매출이 증가했다.

영업이익도 개선되었습니다.
```

### 5. 콜아웃 박스 변환

특수 레이블을 블록쿼트 형식으로 변환합니다.

| 입력 | 출력 | 용도 |
|-----|------|-----|
| `[시사점]` | `> [시사점]` | 핵심 인사이트 |
| `[참고]` | `> [참고]` | 참고 정보 |
| `[주의]` | `> [주의]` | 경고 사항 |
| `[요약]` | `> [요약]` | 요약 박스 |
| `[결론]` | `> [결론]` | 결론 강조 |

```
변환 전: ...중요합니다.[시사점] AI 시장 확대에 따른 수혜가 예상됩니다.

변환 후:
...중요합니다.

> [시사점] AI 시장 확대에 따른 수혜가 예상됩니다.
```

### 6. 불릿 포인트 정규화

다양한 불릿 마커를 표준 마크다운 형식으로 통일합니다.

| 입력 마커 | 출력 |
|----------|------|
| `ㆍ` (가운뎃점) | `- ` |
| `•` (불릿) | `- ` |
| `※` (참고) | `- ` |

### 7. 라벨:값 패턴 처리

보고서에 자주 등장하는 라벨:값 패턴을 별도 라인으로 분리합니다.

```
변환 전: ...분석 결과가정: 연 매출 2조 원트리거 요건: 담보가치 80% 미만...

변환 후:
...분석 결과

- 가정: 연 매출 2조 원

- 트리거 요건: 담보가치 80% 미만

...
```

**처리되는 라벨:**
- `가정:`, `트리거 요건:`, `발동 효과:`
- `구조:`, `적정성:`, `실행 전략:`
- 기타 금융 보고서 전문 용어

### 8. 콜론 간격 정규화

`label:value` 형태를 `label: value`로 정규화합니다.

**예외 처리 (변경하지 않음):**
- URL: `https://example.com`
- 시간: `10:30`
- Windows 경로: `C:\path`

---

## 내부 동작 구조

### 처리 파이프라인 (10단계)

```
┌──────────────────────────────────────────────────────────────┐
│                    format_markdown() 파이프라인               │
├──────────────────────────────────────────────────────────────┤
│  1. LaTeX 보호      │ $...$ → __LATEX_INLINE_0__             │
│  2. Bold 보호       │ **...** → __BOLD_0__                   │
│  3. 콜론 정규화     │ label:value → label: value             │
│  4. 메타데이터 추출 │ 작성일: → YAML frontmatter             │
│  5. 구조 삽입       │ 1. 제목 → ## 1. 제목                   │
│  6. 라벨 분리       │ 가정: → \n\n- 가정:                    │
│  7. Bold 복원       │ __BOLD_0__ → **...**                   │
│  8. LaTeX 복원      │ __LATEX_INLINE_0__ → $...$             │
│  9. 정리            │ 과도한 빈 줄 제거, 헤딩 앞 빈 줄 보장   │
│ 10. Frontmatter     │ YAML 블록을 문서 맨 앞에 추가           │
└──────────────────────────────────────────────────────────────┘
```

### 핵심 컴포넌트

| 클래스 | 역할 |
|--------|------|
| `LaTeXProtector` | LaTeX 수식을 플레이스홀더로 보호/복원 |
| `BoldProtector` | Bold 마커(`**...**`)를 플레이스홀더로 보호/복원 |
| `MetadataExtractor` | 보고서 메타데이터 추출 → YAML 변환 |
| `StructureDetector` | 제목 패턴 감지 → 마크다운 헤딩 삽입 |
| `ColonLabelDetector` | 라벨:값 패턴 처리 및 콜론 간격 정규화 |

### 주요 정규식 패턴

```python
# 주요 섹션 제목 (1. 서론, 2. 본론 등)
MAJOR_HEADING_RE = r"(\d{1,2})\.\\s+([가-힣A-Z][가-힣a-zA-Z\\s()\\-:]{1,50})"

# 한국어 문장 종결
SENTENCE_END_RE = r"(다|요|음|함|임|됨|것|수|점|니다|입니다|습니다)\\.(?=[가-힣A-Z\\[])"

# 콜아웃 레이블
CALLOUT_RE = r"\\[(시사점|참고|주의|결론|요약|핵심|NOTE|WARNING)\\]"

# LaTeX 인라인 수식
LATEX_INLINE_RE = r"(?<!\\$)\\$(?!\\$)(.+?)(?<!\\$)\\$(?!\\$)"
```

---

## CLI 플로우 다이어그램

```
main()
  │
  ├─▶ parse_args()
  │     └─ args.format = True
  │
  └─▶ run_conversion(input_path, args)
        │
        ├─▶ if args.format:
        │     └─▶ auto_format_markdown(input_path)
        │           │
        │           ├─▶ from md_formatter import format_file
        │           └─▶ format_file(input_path)
        │                 │
        │                 ├─▶ _read_with_encoding()
        │                 ├─▶ format_markdown(content)
        │                 │     └─▶ [10-step pipeline]
        │                 └─▶ write output_formatted.md
        │
        │     actual_input = formatted_path
        │
        └─▶ IBReportConverter(actual_input)
              └─▶ convert() → Word 문서 생성
```

---

## 실제 변환 예시

### 입력 (Deep Research 클립보드 복사)

```
[보고서] 네패스 기업분석작성일: 2026년 2월 7일수신: 투자위원회1. 서론글로벌 반도체 산업은 AI가 주도하는 슈퍼 사이클에 진입했다.네패스는 OSAT 산업의 핵심 플레이어이다.[시사점] AI 시장 확대에 따른 수혜가 예상된다.2. 재무분석2.1. 매출 현황가정: 연 매출 5,000억 원예상 성장률은 $r = 0.13$이다.
```

### 출력 (`--format` 적용 후)

```markdown
---
title: "네패스 기업분석"
date: "2026년 2월 7일"
recipient: "투자위원회"
---

## 1. 서론

글로벌 반도체 산업은 AI가 주도하는 슈퍼 사이클에 진입했다.

네패스는 OSAT 산업의 핵심 플레이어이다.

> [시사점] AI 시장 확대에 따른 수혜가 예상된다.

## 2. 재무분석

### 2.1. 매출 현황

- 가정: 연 매출 5,000억 원

예상 성장률은 $r = 0.13$이다.
```

---

## 문제 해결

### Q: 이미 구조화된 파일에 `--format`을 사용하면?

라인 수가 20줄 이상이면 **경량 포맷팅**만 적용됩니다:
- 콜아웃 박스 정규화
- 과도한 빈 줄 제거
- 콜론 간격 정규화

기존 구조는 유지됩니다.

### Q: 변환 결과가 예상과 다를 때?

1. `--check`로 포맷팅 필요 여부 확인:
   ```bash
   uv run md_formatter.py --check input.md
   ```

2. 전처리만 따로 실행하여 중간 결과 확인:
   ```bash
   uv run md_formatter.py input.md
   # input_formatted.md 내용 확인 후
   uv run md_to_word.py input_formatted.md
   ```

### Q: 특정 LaTeX 수식이 깨질 때?

복잡한 수식은 블록 형태(`$$...$$`)로 감싸는 것을 권장합니다:
```markdown
$$
\frac{d}{dx}\left(\int_0^x f(t)dt\right) = f(x)
$$
```

---

## 관련 파일

| 파일 | 역할 |
|------|------|
| `md_to_word.py` | CLI 진입점, `--format` 플래그 처리 |
| `md_formatter.py` | 전처리 로직 구현 |
| `md_parser.py` | 구조화된 마크다운 파싱 |
| `ib_renderer.py` | Word 문서 렌더링 |
